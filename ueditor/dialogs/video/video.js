(function(){var e,t=[],a=!1;function i(){for(var e=$G("tabHeads").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",(function(t){var a,i,r=t.target||t.srcElement;for(a=0;a<e.length;a++)i=e[a].getAttribute("data-content-id"),e[a]==r?(domUtils.addClass(e[a],"focus"),domUtils.addClass($G(i),"focus")):(domUtils.removeClasses(e[a],"focus"),domUtils.removeClasses($G(i),"focus"))}))}function r(){f(["videoFloat","upload_alignment"]),v($G("videoUrl")),o(),function(){var e,t=editor.selection.getRange().getClosedNode();if(t&&t.className){var i="edui-faked-video"==t.className,r=-1!=t.className.indexOf("edui-upload-video");if(i||r){$G("videoUrl").value=e=t.getAttribute("_url"),$G("videoWidth").value=t.width,$G("videoHeight").value=t.height;var o=domUtils.getComputedStyle(t,"float"),s=domUtils.getComputedStyle(t.parentNode,"text-align");n("center"===s?"center":o)}r&&(a=!0)}g(e)}()}function o(){dialog.onok=function(){$G("preview").innerHTML="";var e=d("tabHeads","tabSrc");switch(e){case"video":return s();case"videoSearch":return l("searchList");case"upload":return h()}},dialog.oncancel=function(){$G("preview").innerHTML=""}}function n(e){for(var t,a=$G("videoFloat").children,i=0;t=a[i++];)t.getAttribute("name")==e?"focus"!=t.className&&(t.className="focus"):"focus"==t.className&&(t.className="")}function s(){var e=$G("videoWidth"),t=$G("videoHeight"),i=$G("videoUrl").value,r=d("videoFloat","name");return!!i&&(!!c([e,t])&&void editor.execCommand("insertvideo",{url:u(i),width:e.value,height:t.value,align:r},a?"upload":null))}function l(e){for(var t,a=domUtils.getElementsByTagName($G(e),"img"),i=[],r=0;t=a[r++];)t.getAttribute("selected")&&i.push({url:t.getAttribute("ue_video_url"),width:420,height:280,align:"none"});editor.execCommand("insertvideo",i)}function d(e,t){for(var a,i,r=$G(e).children,o=0;i=r[o++];)if("focus"==i.className){a=i.getAttribute(t);break}return a}function u(e){return e?(e=utils.trim(e).replace(/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"player.youku.com/player.php/sid/$1/v.swf").replace(/(www\.)?youtube\.com\/watch\?v=([\w\-]+)/i,"www.youtube.com/v/$2").replace(/youtu.be\/(\w+)$/i,"www.youtube.com/v/$1").replace(/v\.ku6\.com\/.+\/([\w\.]+)\.html.*$/i,"player.ku6.com/refer/$1/v.swf").replace(/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"player.56.com/v_$1.swf").replace(/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"player.56.com/v_$1.swf").replace(/v\.pps\.tv\/play_([\w]+)\.html.*$/i,"player.pps.tv/player/sid/$1/v.swf").replace(/www\.letv\.com\/ptv\/vplay\/([\d]+)\.html.*$/i,"i7.imgs.letv.com/player/swfPlayer.swf?id=$1&autoplay=0").replace(/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"www.tudou.com/v/$1").replace(/v\.qq\.com\/cover\/[\w]+\/[\w]+\/([\w]+)\.html/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/v\.qq\.com\/.+[\?\&]vid=([^&]+).*$/i,"static.video.qq.com/TPout.swf?vid=$1").replace(/my\.tv\.sohu\.com\/[\w]+\/[\d]+\/([\d]+)\.shtml.*$/i,"share.vrs.sohu.com/my/v.swf&id=$1"),e):""}function c(e){for(var t,a=0;t=e[a++];){var i=t.value;if(!p(i)&&i)return alert(lang.numError),t.value="",t.focus(),!1}return!0}function p(e){return/(0|^[1-9]\d*$)/.test(e)}function f(e){for(var t,a=0;t=e[a++];){var i=$G(t),r={none:lang["default"],left:lang.floatLeft,right:lang.floatRight,center:lang.block};for(var o in r){var n=document.createElement("div");n.setAttribute("name",o),"none"==o&&(n.className="focus"),n.style.cssText="background:url(images/"+o+"_focus.jpg);",n.setAttribute("title",r[o]),i.appendChild(n)}m(t)}}function m(e){for(var t,a=$G(e).children,i=0;t=a[i++];)domUtils.on(t,"click",(function(){for(var e,t=0;e=a[t++];)e.className="",e.removeAttribute&&e.removeAttribute("class");this.className="focus"}))}function v(e){browser.ie?e.onpropertychange=function(){g(this.value)}:e.addEventListener("input",(function(){g(this.value)}),!1)}function g(e){if(e){var t=u(e);t=utils.unhtmlForUrl(t),$G("preview").innerHTML='<div class="previewMsg"><span>'+lang.urlError+'</span></div><embed class="previewVideo" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+t+'" width="420" height="280" wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" ></embed>'}}function h(){var a=[],i=editor.getOpt("videoUrlPrefix"),r=parseInt($G("upload_width").value,10)||420,o=parseInt($G("upload_height").value,10)||280,n=d("upload_alignment","name")||"none";for(var s in t){var l=t[s];a.push({url:i+l.url,width:r,height:o,align:n})}var u=e.getQueueCount();if(u)return $(".info","#queueList").html('<span style="color:red;">'+"\u8fd8\u67092\u4e2a\u672a\u4e0a\u4f20\u6587\u4ef6".replace(/[\d]/,u)+"</span>"),!1;editor.execCommand("insertvideo",a,"upload")}function w(){e=new b("queueList")}function b(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}window.onload=function(){$focus($G("videoUrl")),i(),r(),w()},b.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var e,a=this,i=jQuery,r=a.$wrap,o=r.find(".filelist"),n=r.find(".statusBar"),s=n.find(".info"),l=r.find(".uploadBtn"),d=(r.find(".filePickerBtn"),r.find(".filePickerBlock")),u=r.find(".placeholder"),c=n.find(".progress").hide(),p=0,f=0,m=window.devicePixelRatio||1,v=113*m,g=113*m,h="",w={},b=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,t}(),y=editor.getActionUrl(editor.getOpt("videoActionName")),$=editor.getOpt("videoMaxSize"),k=(editor.getOpt("videoAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");function C(t){var a=i('<li id="'+t.id+'"><p class="title">'+t.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),r=i('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(a),o=a.find("p.progress span"),n=a.find("p.imgWrap"),s=i('<p class="error"></p>').hide().appendTo(a),l=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry;break}s.text(text).show()};"invalid"===t.getStatus()?l(t.statusText):(n.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+t.ext.toLowerCase()+"|")?n.empty().addClass("notimage").append('<i class="file-preview file-type-'+t.ext.toLowerCase()+'"></i><span class="file-title">'+t.name+"</span>"):browser.ie&&browser.version<=7?n.text(lang.uploadNoPreview):e.makeThumb(t,(function(e,t){if(e||!t||/^data:/.test(t)&&browser.ie&&browser.version<=7)n.text(lang.uploadNoPreview);else{var a=i('<img src="'+t+'">');n.empty().append(a),a.on("error",(function(){n.text(lang.uploadNoPreview)}))}}),v,g),w[t.id]=[t.size,0],t.rotation=0,t.ext&&-1!=k.indexOf(t.ext.toLowerCase())||(l("not_allow_type"),e.removeFile(t))),t.on("statuschange",(function(e,i){"progress"===i?o.hide().width(0):"queued"===i&&(a.off("mouseenter mouseleave"),r.remove()),"error"===e||"invalid"===e?(l(t.statusText),w[t.id][1]=1):"interrupt"===e?l("interrupt"):"queued"===e?w[t.id][1]=0:"progress"===e&&(s.hide(),o.css("display","block")),a.removeClass("state-"+i).addClass("state-"+e)})),a.on("mouseenter",(function(){r.stop().animate({height:30})})),a.on("mouseleave",(function(){r.stop().animate({height:0})})),r.on("click","span",(function(){var a,r=i(this).index();switch(r){case 0:return void e.removeFile(t);case 1:t.rotation+=90;break;case 2:t.rotation-=90;break}b?(a="rotate("+t.rotation+"deg)",n.css({"-webkit-transform":a,"-mos-transform":a,"-o-transform":a,transform:a})):n.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(t.rotation/90%4+4)%4+")")})),a.insertBefore(d)}function x(e){var t=i("#"+e.id);delete w[e.id],_(),t.off().find(".file-panel").off().end().remove()}function _(){var e,t=0,a=0,r=c.children();i.each(w,(function(e,i){a+=i[0],t+=i[0]*i[1]})),e=a?t/a:0,r.eq(0).text(Math.round(100*e)+"%"),r.eq(1).css("width",Math.round(100*e)+"%"),N()}function S(t,i){if(t!=h){var r=e.getStats();switch(l.removeClass("state-"+h),l.addClass("state-"+t),t){case"pedding":o.addClass("element-invisible"),n.addClass("element-invisible"),u.removeClass("element-invisible"),c.hide(),s.hide(),e.refresh();break;case"ready":u.addClass("element-invisible"),o.removeClass("element-invisible"),n.removeClass("element-invisible"),c.hide(),s.show(),l.text(lang.uploadStart),e.refresh();break;case"uploading":c.show(),s.hide(),l.text(lang.uploadPause);break;case"paused":c.show(),s.hide(),l.text(lang.uploadContinue);break;case"confirm":if(c.show(),s.hide(),l.text(lang.uploadStart),r=e.getStats(),r.successNum&&!r.uploadFailNum)return void S("finish");break;case"finish":c.hide(),s.show(),r.uploadFailNum?l.text(lang.uploadRetry):l.text(lang.uploadStart);break}h=t,N()}a.getQueueCount()?l.removeClass("disabled"):l.addClass("disabled")}function N(){var t,a="";"ready"===h?a=lang.updateStatusReady.replace("_",p).replace("_KB",WebUploader.formatSize(f)):"confirm"===h?(t=e.getStats(),t.uploadFailNum&&(a=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum))):(t=e.getStats(),a=lang.updateStatusFinish.replace("_",p).replace("_KB",WebUploader.formatSize(f)).replace("_",t.successNum),t.uploadFailNum&&(a+=lang.updateStatusError.replace("_",t.uploadFailNum))),s.html(a)}WebUploader.Uploader.support()?editor.getOpt("videoActionName")?(e=a.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:y,fileVal:editor.getOpt("videoFieldName"),duplicate:!0,fileSingleSizeLimit:$,compress:!1}),e.addButton({id:"#filePickerBlock"}),e.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),S("pedding"),e.on("fileQueued",(function(e){p++,f+=e.size,1===p&&(u.addClass("element-invisible"),n.show()),C(e)})),e.on("fileDequeued",(function(e){p--,f-=e.size,x(e),_()})),e.on("filesQueued",(function(t){e.isInProgress()||"pedding"!=h&&"finish"!=h&&"confirm"!=h&&"ready"!=h||S("ready"),_()})),e.on("all",(function(t,a){switch(t){case"uploadFinished":S("confirm",a);break;case"startUpload":var i=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",r=utils.formatUrl(y+(-1==y.indexOf("?")?"?":"&")+"encode=utf-8&"+i);e.option("server",r),S("uploading",a);break;case"stopUpload":S("paused",a);break}})),e.on("uploadBeforeSend",(function(e,t,a){a["X_Requested_With"]="XMLHttpRequest"})),e.on("uploadProgress",(function(e,t){var a=i("#"+e.id),r=a.find(".progress span");r.css("width",100*t+"%"),w[e.id][1]=t,_()})),e.on("uploadSuccess",(function(e,a){var r=i("#"+e.id);try{var o=a._raw||a,n=utils.str2json(o);"SUCCESS"==n.state?(t.push({url:n.url,type:n.type,original:n.original}),r.append('<span class="success"></span>')):r.find(".error").text(n.state).show()}catch(s){r.find(".error").text(lang.errorServerUpload).show()}})),e.on("uploadError",(function(e,t){})),e.on("error",(function(e,t){"Q_TYPE_DENIED"!=e&&"F_EXCEED_SIZE"!=e||C(t)})),e.on("uploadComplete",(function(e,t){})),l.on("click",(function(){if(i(this).hasClass("disabled"))return!1;"ready"===h||"paused"===h?e.upload():"uploading"===h&&e.stop()})),l.addClass("state-"+h),_()):i("#filePickerReady").after(i("<div>").html(lang.errorLoadConfig)).hide():i("#filePickerReady").after(i("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var e,t,a,i=0,r=this.uploader.getFiles();for(t=0;e=r[t++];)a=e.getStatus(),"queued"!=a&&"uploading"!=a&&"progress"!=a||i++;return i},refresh:function(){this.uploader.refresh()}}})();